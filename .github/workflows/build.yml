name: build

on: [push]

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        buildType: ["Debug", "Release"]
        buildArch: ["Win32", "x64"]
    steps:
    - uses: actions/checkout@v2

    - name: Setup NuGet Credentials
      run: >
        nuget sources add
        -source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"
        -storepasswordincleartext
        -name "GitHub"
        -username "${{ github.repository_owner }}"
        -password "${{ secrets.GITHUB_TOKEN }}"

    - name: run-cmake
      env:
        CXXFLAGS: /WX
      run: |
        mkdir cmake_out
        cd cmake_out
        cmake -A${{ matrix.buildArch }} ../
        cmake --build . --config ${{ matrix.buildType }}
    # - name: run-cmake
    #   uses: lukka/run-cmake@v2.5
    #   with:
    #     cmakeAppendedArgs: '-G "Visual Studio 16 2019" -A${{ matrix.buildArch }} -D CMAKE_CXX_FLAGS=/WX'
    #     cmakeBuildType: ${{ matrix.buildType }}



  build-linux:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        buildType: ["Debug", "Release"]
        buildCompiler:
          - exe: g++-9
            deps: ""
          - exe: clang++-9
            deps: clang-9 libc++-9-dev libc++abi-9-dev
          - exe: clang++-10
            deps: "clang-10 libc++-10-dev libc++abi-10-dev"

    steps:
    - uses: actions/checkout@v2

    - name: Setup NuGet Credentials
      run: >
        nuget sources add
        -source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"
        -storepasswordincleartext
        -name "GitHub"
        -username "${{ github.repository_owner }}"
        -password "${{ secrets.GITHUB_TOKEN }}"

    - name: Add repos
      run: |
        sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 15CF4D18AF4F7421
        sudo add-apt-repository ppa:ubuntu-toolchain-r/test
        echo "deb http://apt.llvm.org/focal/ llvm-toolchain-focal main" | sudo tee /etc/apt/sources.list.d/llvm.list
        sudo apt update

    - run: sudo apt install ${{ matrix.buildCompiler.deps }}

    - name: run-cmake
      env:
        CXX: ${{ matrix.buildCompiler.exe }}
        CXXFLAGS: -Werror -Wall -Wpedantic -Wextra
      run: |
        mkdir cmake_out
        cd cmake_out
        cmake -DCMAKE_BUILD_TYPE=${{ matrix.buildType }} ../
        cmake --build .



  build-macos:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        buildType: ["Debug", "Release"]

    steps:
    - uses: actions/checkout@v2

    - name: Setup NuGet Credentials
      run: >
        nuget sources add
        -source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"
        -storepasswordincleartext
        -name "GitHub"
        -username "${{ github.repository_owner }}"
        -password "${{ secrets.GITHUB_TOKEN }}"

    - name: run-cmake
      env:
        CXXFLAGS: -Werror -Wall -Wpedantic -Wextra
      run: |
        mkdir cmake_out
        cd cmake_out
        cmake -DCMAKE_BUILD_TYPE=${{ matrix.buildType }} ../
        cmake --build .
